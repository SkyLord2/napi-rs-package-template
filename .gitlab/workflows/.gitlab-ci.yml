stages:
  - lint
  - build
  # - test
  # - publish

variables:
  # 全局变量
  APP_NAME: 'package-template' # 对应 package.json 的 binaryName
  MACOSX_DEPLOYMENT_TARGET: '10.13'
  CARGO_INCREMENTAL: '1'
  # 配置 pnpm 缓存路径
  PNPM_HOME: ${CI_PROJECT_DIR}/.pnpm
  PATH: ${CI_PROJECT_DIR}/.pnpm:$PATH
  # 开启 Docker in Docker (用于 Linux 跨平台构建)
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ''

# 缓存配置
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - target/
  policy: pull-push

# 基础环境模版（用于 Linux 任务）
.base-linux:
  image: node:20-buster # 使用包含 Node 和基础构建工具的镜像
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.27.0 --activate
    - pnpm config set store-dir .pnpm-store
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env

# =======================
# 1. Lint 阶段
# =======================
lint:
  stage: lint
  extends: .base-linux
  script:
    - rustup component add clippy rustfmt
    - pnpm install
    - pnpm lint
    - cargo fmt -- --check
    - cargo clippy
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# =======================
# 2. Build 阶段
# =======================

# --- Linux 构建 (包含 Android/Musl) ---
build-linux:
  stage: build
  extends: .base-linux
  # 启用 Docker 服务以支持 cross-compilation
  services:
    - docker:dind
  script:
    - pnpm install
    - |
      if [[ "$TARGET" == *"musl"* || "$TARGET" == *"android"* || "$TARGET" == *"arm"* ]]; then
        pnpm build --target $TARGET --use-napi-cross
      else
        pnpm build --target $TARGET
      fi
  parallel:
    matrix:
      - TARGET:
          - x86_64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-gnu
          - aarch64-unknown-linux-musl
          - armv7-unknown-linux-gnueabihf
          - aarch64-linux-android
          - armv7-linux-androideabi
        # - wasm32-wasip1-threads # 如果需要 WASI，取消注释
  artifacts:
    name: 'bindings-$TARGET'
    paths:
      - '*.node'
      - '*.wasm'
    expire_in: 1 day

# --- Windows 构建 ---
# 注意: 需要你有配置 tag 为 "windows" 的 GitLab Runner (Shell Executor)
build-windows:
  stage: build
  tags:
    - windows
  script:
    # PowerShell 脚本
    - corepack enable
    - corepack prepare pnpm@10.27.0 --activate
    - pnpm install
    - pnpm build --target $env:TARGET
  parallel:
    matrix:
      - TARGET:
          - x86_64-pc-windows-msvc
          - i686-pc-windows-msvc
          - aarch64-pc-windows-msvc
  artifacts:
    name: 'bindings-$env:TARGET'
    paths:
      - '*.node'
    expire_in: 1 day

# --- macOS 构建 ---
# 注意: 需要你有配置 tag 为 "macos" 的 GitLab Runner (Shell Executor)
build-macos:
  stage: build
  tags:
    - macos
    # 如果是 GitLab SaaS Premium，可以使用: saas-macos-medium-m1
  script:
    - corepack enable
    - corepack prepare pnpm@10.27.0 --activate
    - pnpm install
    - pnpm build --target $TARGET
    - strip -x *.node
  parallel:
    matrix:
      - TARGET:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
  artifacts:
    name: 'bindings-$TARGET'
    paths:
      - '*.node'
    expire_in: 1 day

# --- FreeBSD 构建 (可选) ---
# GitLab 很少有原生的 FreeBSD Runner。
# 如果必须支持，通常建议忽略此步，或者在 Linux 上使用 QEMU 模拟 (极其缓慢且复杂)。
# 此处略过以保证流水线可用性。

# =======================
# 3. Test 阶段
# =======================
# test-bindings:
#   stage: test
#   extends: .base-linux
#   needs: ["build-linux"] # 仅演示测试 Linux 产物，Windows/Mac 同理
#   script:
#     - pnpm install
#     - ls -lh *.node
#     - pnpm test
# 这里可以添加逻辑使用 QEMU 测试 arm/aarch64，类似 GitHub Action 的 setup-qemu

# =======================
# 4. Publish 阶段
# =======================
# publish:
#   stage: publish
#   extends: .base-linux
#   needs:
#     - build-linux
#     - build-windows
#     - build-macos
#   script:
#     - pnpm install
#     - pnpm napi create-npm-dirs
#     - pnpm artifacts # 将下载的 artifacts 移动到 npm 目录
#     - ls -R ./npm
#     - |
#       # 检查 Commit 信息是否包含版本号 (例如 1.0.0)
#       if git log -1 --pretty=%B | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+$"; then
#         echo "Detected release commit, publishing..."
#         echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
#         npm publish --access public
#       elif git log -1 --pretty=%B | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+"; then
#         echo "Detected beta/next release..."
#         echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
#         npm publish --tag next --access public
#       else
#         echo "Not a release commit, skipping publish."
#       fi
#   rules:
#     - if: $CI_COMMIT_BRANCH == "main"
